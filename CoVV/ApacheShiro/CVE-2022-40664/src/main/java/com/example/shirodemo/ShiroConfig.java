package com.example.shirodemo;

import org.apache.shiro.mgt.SecurityManager;
import org.apache.shiro.spring.web.ShiroFilterFactoryBean;
import org.apache.shiro.web.config.ShiroFilterConfiguration;
import org.apache.shiro.web.mgt.DefaultWebSecurityManager;
import org.apache.shiro.web.servlet.AbstractShiroFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.servlet.DispatcherType;
import javax.servlet.Filter;
import java.util.AbstractCollection;
import java.util.EnumSet;
import java.util.HashMap;
import java.util.Map;
@Configuration
public class ShiroConfig {

    @Bean
    public SecurityManager securityManager() {
        return new DefaultWebSecurityManager();
    }

    @Bean
    public MyShiroFilterFactoryBean filterRegBean(SecurityManager securityManager) throws Exception {
        // CVE-2022-40664
        // fixed conf
        ShiroFilterConfiguration conf = new ShiroFilterConfiguration();
        conf.setFilterOncePerRequest(false);

        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        shiroFilterFactoryBean.setShiroFilterConfiguration(conf);
        AbstractShiroFilter filter = shiroFilterFactoryBean.getObject();

        MyShiroFilterFactoryBean reg = new MyShiroFilterFactoryBean();
        reg.setFilter(filter);
        reg.addUrlPattern("/*");
        reg.setName("shiroFilter");
        reg.setSecurityManager(securityManager);
        reg.setDispatcherTypes(EnumSet.allOf(DispatcherType.class));
        //fixed conf end.
        return reg;
    }
}